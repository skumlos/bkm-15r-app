#include <stdio.h>
#include <sys/socket.h> 
#include <arpa/inet.h>
#include <unistd.h>
#include <fcntl.h>
#include <termios.h>

#define MONITOR_PORT (53484)
#define MONITOR_DEFAULT_IP "192.168.0.1"

// status word 0
#define POWER_ON_STATUS     (0x8000)
#define SCANMODE_STATUS     (0x0400)
#define HDELAY_STATUS       (0x0200)
#define VDELAY_STATUS       (0x0100)
#define MONOCHROME_STATUS   (0x0080)
#define CHAR_MUTE_STATUS    (0x0040)
#define MARKER_MODE_STATUS  (0x0020)
#define EXTSYNC_STATUS      (0x0010)
#define APT_STATUS          (0x0008)
#define CHROMA_UP_STATUS    (0x0004)
#define ASPECT_STATUS       (0x0002)

// status word 1

// status word 2
#define COL_TEMP_STATUS     (0x0040)
#define COMB_STATUS         (0x0020)
#define BLUE_ONLY_STATUS    (0x0010)
#define R_CUTOFF_STATUS     (0x0004)
#define G_CUTOFF_STATUS     (0x0002)
#define B_CUTOFF_STATUS     (0x0001)

// status word 3
#define MAN_PHASE_STATUS    (0x0080)
#define MAN_CHROMA_STATUS   (0x0040)
#define MAN_BRIGHT_STATUS   (0x0020)
#define MAN_CONTRAST_STATUS (0x0010)

int main(int argc , char *argv[])
{
	int sockfd;
    int rc = 0;
	struct sockaddr_in monitor;
    int disconnect = 0;
    struct termios ctrl;
    char command;
    const char header [6] = { 0x03, 0x0B, 'S', 'O', 'N', 'Y' };

    const char get_status[31] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x12,0x53,0x54,0x41,0x54,0x67,0x65,0x74,0x20,0x43,0x55,0x52,0x52,0x45,0x4e,0x54,0x20,0x35,0x00 };
    
    const char menu_press[29] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x10,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x4d,0x45,0x4e,0x55,0x20 };
    const char menu_up [31] =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x12,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x4d,0x45,0x4e,0x55,0x55,0x50,0x20 };
    const char menu_down[33] =  { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x14,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x4d,0x45,0x4e,0x55,0x44,0x4f,0x57,0x4e,0x20 };
    const char menu_enter[32] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x13,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x4d,0x45,0x4e,0x55,0x45,0x4e,0x54,0x20 };

    const char info_button_1[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x31,0x20 };
    const char info_button_2[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x32,0x20 };
    const char info_button_3[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x33,0x20 };
    const char info_button_4[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x34,0x20 };
    const char info_button_5[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x35,0x20 };
    const char info_button_6[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x36,0x20 };
    const char info_button_7[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x37,0x20 };
    const char info_button_8[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x38,0x20 };
    const char info_button_9[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x39,0x20 };
    const char info_button_0[26] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x0d,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x30,0x20 };
    const char info_button_del[31] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x12,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x44,0x45,0x4c,0x45,0x54,0x45,0x20 };
    const char info_button_ent[30] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x11,0x49,0x4e,0x46,0x4f,0x62,0x75,0x74,0x74,0x6f,0x6e,0x20,0x45,0x4e,0x54,0x45,0x52,0x20 };

    const char status_power_toggle[33]  =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x14,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x50,0x4f,0x57,0x45,0x52,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_power_degauss[29]  =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x10,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x44,0x45,0x47,0x41,0x55,0x53,0x53,0x20 };
    
    const char status_scanmode_toggle[36] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x17,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x53,0x43,0x41,0x4e,0x4d,0x4f,0x44,0x45,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_hdelay_toggle[34] =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x48,0x44,0x45,0x4c,0x41,0x59,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_vdelay_toggle[34] =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x56,0x44,0x45,0x4c,0x41,0x59,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_monoch_toggle[35] =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x16,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x4d,0x4f,0x4e,0x4f,0x43,0x48,0x52,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_apt_toggle[36] =      { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x17,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x41,0x50,0x45,0x52,0x54,0x55,0x52,0x45,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_comb_toggle[32] =     { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x13,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x43,0x4f,0x4d,0x42,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_char_mute[36] =       { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x17,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x43,0x48,0x41,0x52,0x4d,0x55,0x54,0x45,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_col_temp[34] =        { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x43,0x4f,0x4c,0x41,0x44,0x4a,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    
    const char status_aspect_toggle[34] =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x41,0x53,0x50,0x45,0x43,0x54,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_extsync_toggle[35] =  { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x16,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x45,0x58,0x54,0x53,0x59,0x4e,0x43,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_blue_only[36] =       { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x17,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x42,0x4c,0x55,0x45,0x4f,0x4e,0x4c,0x59,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_r_cutoff_toggle[35] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x16,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x52,0x43,0x55,0x54,0x4f,0x46,0x46,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45};
    const char status_g_cutoff_toggle[35] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x16,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x47,0x43,0x55,0x54,0x4f,0x46,0x46,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_b_cutoff_toggle[35] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x16,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x42,0x43,0x55,0x54,0x4f,0x46,0x46,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_marker_toggle[34] =   { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x4d,0x41,0x52,0x4b,0x45,0x52,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 }; 
    const char status_chroma_up_toggle[36] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x17,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x43,0x48,0x52,0x4f,0x4d,0x41,0x55,0x50,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    
    const char status_man_phase_toggle[36] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x17,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x4d,0x41,0x4e,0x50,0x48,0x41,0x53,0x45,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_man_chroma_toggle[34] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x4d,0x41,0x4e,0x43,0x48,0x52,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_man_bright_toggle[34] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x15,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x4d,0x41,0x4e,0x42,0x52,0x54,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    const char status_man_contrast_toggle[35] = { 0x03,0x0b,0x53,0x4f,0x4e,0x59,0x00,0x00,0x00,0xb0,0x00,0x00,0x16,0x53,0x54,0x41,0x54,0x73,0x65,0x74,0x20,0x4d,0x41,0x4e,0x43,0x4f,0x4e,0x54,0x20,0x54,0x4f,0x47,0x47,0x4c,0x45 };
    
    char status_response[53];
    char button_response[13];

    fcntl(0, F_SETFL, fcntl(0, F_GETFL) | O_NONBLOCK);
    tcgetattr(STDIN_FILENO, &ctrl);
    ctrl.c_lflag &= ~ICANON; // make input unbuffered, so enter after keypress isn't needed
    ctrl.c_lflag &= ~ECHO; // turn off echo so we don't see the 
    tcsetattr(STDIN_FILENO, TCSANOW, &ctrl);

    sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if (sockfd == -1)
	{
		fprintf(stderr,"Could not create socket");
		return 1;
	}

    monitor.sin_addr.s_addr = inet_addr(MONITOR_DEFAULT_IP);
	monitor.sin_family = AF_INET;
	monitor.sin_port = htons(MONITOR_PORT);

    fprintf(stdout,"Connecting to monitor @ %s:%d\n",MONITOR_DEFAULT_IP,MONITOR_PORT);
	if (connect(sockfd , (struct sockaddr *)&monitor , sizeof(monitor)) < 0)
	{
		fprintf(stderr,"Could not connect");
		return 2;
    }

    fprintf(stdout,"Connected, starting loop\n");
    fprintf(stdout,"Supported keys:\n");
    fprintf(stdout,"p - Power toggle\n");
    fprintf(stdout,"a - Aspect ratio (16:9) toggle\n");
    fprintf(stdout,"m - Menu\n");
    fprintf(stdout,"Enter - Enter (menu)\n");   
    fprintf(stdout,"Arrow-up - Navigate up (menu)\n");   
    fprintf(stdout,"Arrow-down - Navigate down (menu)\n");   

    while(!disconnect) {
        if(read(0, &command, 1) == 1) {
            switch(command) {
                case 'm':
                    fprintf(stdout,"MENU\n");
                    if(send(sockfd, menu_press, sizeof(menu_press), 0) < 0) {
                        fprintf(stderr,"Failed sending MENU\n");
                        goto fail;
                    }
                    recv(sockfd, button_response,sizeof(button_response),0);
                break;
                case 0x0A:
                    fprintf(stdout,"MENU ENTER\n");
                    if(send(sockfd, menu_enter, sizeof(menu_enter), 0) < 0) {
                        fprintf(stderr,"Failed sending MENU ENTER\n");
                        goto fail;
                    }
                    recv(sockfd, button_response,sizeof(button_response),0);
                break;
                case 'a':
                    fprintf(stdout,"ASPECT\n");
                    if(send(sockfd, status_aspect_toggle, sizeof(status_aspect_toggle), 0) < 0) {
                        fprintf(stderr,"Failed sending ASPECT\n");
                        goto fail;
                    }
                    recv(sockfd, button_response,sizeof(button_response),0);
                break;
                case 'p':
                    fprintf(stdout,"POWER\n");
                    if(send(sockfd, status_power_toggle, sizeof(status_power_toggle), 0) < 0) {
                        fprintf(stderr,"Failed sending POWER\n");
                        goto fail;
                    }
                    recv(sockfd, button_response,sizeof(button_response),0);
                break;
                case 'q':
                    disconnect = 1;
                break;
                case 0x1B:
                    if(read(0, &command, 1) == 1) {
                        switch(command) {
                            case 0x5B:
                                if(read(0, &command, 1) == 1) {
                                    switch(command) {
                                        case 0x41: // up
                                            fprintf(stdout,"UP\n");
                                            if(send(sockfd, menu_up, sizeof(menu_up), 0) < 0) {
                                                fprintf(stderr,"Failed sending MENU UP\n");
                                                goto fail;
                                            }
                                            recv(sockfd, button_response,sizeof(button_response),0);
                                        break;
                                        case 0x42: // down
                                            fprintf(stdout,"DOWN\n");
                                            if(send(sockfd, menu_down, sizeof(menu_down), 0) < 0) {
                                                fprintf(stderr,"Failed sending MENU DOWN\n");
                                                goto fail;
                                            }
                                            recv(sockfd, button_response,sizeof(button_response),0);
                                        break;
                                        default:
                                        break;
                                    }
                                }
                            break;
                            default:
                            break;
                        }
                    }
                break;
                default:
                break;
            }
        }

        if(send(sockfd, get_status, sizeof(get_status), 0) < 0)
	    {
		    fprintf(stderr,"Sending get status failed...\n");
		    goto fail;
	    }
        recv(sockfd,status_response,sizeof(status_response),0);
        usleep(500*1000);
    }
    goto close;

fail:
    rc = 3;

close:
    fprintf(stderr,"Closing connection, and exiting...\n");
    close(sockfd);
    ctrl.c_lflag |= ECHO; // turn echo back on again
    ctrl.c_lflag |= ICANON; // make input buffered again
    tcsetattr(STDIN_FILENO, TCSANOW, &ctrl);
    return rc;
}